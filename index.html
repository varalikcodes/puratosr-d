<script>
    const questions = [
      { question: "Is the product or technology innovative?", options: ["Yes", "No"], next: [2, 1] }, // 0
      { question: "<span style='color:#FF0000'>No-Go</span>", options: [], next: [-1] }, // 1
      { question: "Has Puratos recently done a similar collaboration?", options: ["Yes", "No"], next: [1, 3] }, // 2
      { question: "Is the collaborator's work relevant to a Puratos business unit?", options: ["Yes", "No"], next: [4, 1] }, // 3
      { question: "Is there customer demand for this type of product?", options: ["Yes", "No"], next: [5, 6] }, // 4
      { question: "Has the technology/product been done by someone else?", options: ["Yes", "No"], next: [7, 8] }, // 5
      { question: "Is it aligned with the goals of other internal teams?", options: ["Yes", "No"], next: [5, 8] }, // 6
      { question: "Is the collaborator closer to commercialization or are they more specialized than competitors?", options: ["Yes", "No"], next: [8, 1] }, // 7
      { question: "Do they already have a contract in place with another company?", options: ["Yes", "No"], next: [1, 9] }, // 8
      { question: "Is the collaborator Scope 1 neutral, or working on it?", options: ["Yes", "No"], next: [10, 1] }, // 9
      { question: "Are they, or do they have a plan to be Scope 2 and 3 neutral?", options: ["Yes", "No"], next: [11, 1] }, // 10
      { question: "Is the collaborator aligned with environmental and social sustainability initiatives?", options: ["Yes", "No"], next: [12, 1] }, // 11
      { question: "What category best fits the collaboration?", options: ["Technology", "Ingredient"], next: [13, 14] }, // 12
      { question: "Is the technology currently operational?", options: ["Yes", "No"], next: [18, 19] }, // 13
      { question: "Is it GRAS-certified?", options: ["Yes", "No"], next: [15, 16] }, // 14
      { question: "Are there allergens in the product?", options: ["Yes", "No"], next: [1, 23] }, // 15
      { question: "Does the collaborator have a plan to obtain certification?", options: ["Yes", "No"], next: [15, 1] }, // 16
      { question: "Is it GMO-free?", options: ["Yes", "No"], next: [18, 1] }, // 17
      { question: "Is it patented or protected?", options: ["Yes", "No"], next: [20, 21] }, // 18
      { question: "Is there a working prototype or demo available?", options: ["Yes", "No"], next: [18, 1] }, // 19
      { question: "Does the company have the capacity to scale with Puratos?", options: ["Yes", "No"], next: [23, 22] }, // 20
      { question: "Is there a plan in place to patent or protect it?", options: ["Yes", "No"], next: [20, 1] }, // 21
      { question: "Is the collaborator open to co-development?", options: ["Yes", "No"], next: [23, 1] }, // 22
      { question: "<span style='color:#008000'>GO!</span>", options: [], next: [-1] } // 23
    ]; // Keep original questions array here
    let currentQuestionIndex = 0;
    let history = [];
    let decisions = [];
    let notesMap = {};

    function stripHTML(html) {
      const div = document.createElement("div");
      div.innerHTML = html;
      return div.textContent || div.innerText || "";
    }

    function renderQuestion() {
      const currentQuestion = questions[currentQuestionIndex];
      document.getElementById('question').innerHTML = currentQuestion.question;
      const optionsContainer = document.getElementById('options');
      optionsContainer.innerHTML = '';
      if (currentQuestion.options.length > 0) {
        optionsContainer.style.display = 'flex';
        currentQuestion.options.forEach((option, index) => {
          const button = document.createElement('button');
          button.className = 'btn';
          button.textContent = option;
          button.onclick = () => nextQuestion(index);
          optionsContainer.appendChild(button);
        });
      } else {
        optionsContainer.style.display = 'none';
      }
      document.getElementById('notes').value = notesMap[currentQuestionIndex] || '';
      updateProgressBar();
    }

    function nextQuestion(optionIndex) {
      const currentQuestion = questions[currentQuestionIndex];
      const answer = currentQuestion.options[optionIndex];
      decisions.push({
        question: stripHTML(currentQuestion.question),
        answer: answer,
        notes: document.getElementById('notes')?.value || ""
      });
      notesMap[currentQuestionIndex] = document.getElementById('notes')?.value || "";
      const nextIndex = currentQuestion.next[optionIndex];
      if (nextIndex !== -1) {
        history.push(currentQuestionIndex);
        currentQuestionIndex = nextIndex;
        renderQuestion();
      } else {
        showSummary();
      }
    }

    function returnQuestion() {
      notesMap[currentQuestionIndex] = document.getElementById('notes')?.value || "";
      if (history.length > 0) {
        currentQuestionIndex = history.pop();
        renderQuestion();
      }
    }

    function startOver() {
      history = [];
      currentQuestionIndex = 0;
      decisions = [];
      notesMap = {};
      renderQuestion();
    }

    function updateProgressBar() {
      const totalSteps = questions.length;
      const isTerminal = questions[currentQuestionIndex].next.length === 1 && questions[currentQuestionIndex].next[0] === -1;
      const completedSteps = isTerminal ? totalSteps : Math.min(history.length + 1, totalSteps);
      const progressPercent = (completedSteps / totalSteps) * 100;
      document.getElementById('progressBar').style.width = `${progressPercent}%`;
    }

    function showSummary() {
      const container = document.getElementById('container');
      container.innerHTML = `<div class="inner-title">Your Decision Path</div><ul id="decisionTree"></ul><button class="btn" onclick="downloadSummary()">Download Summary</button>`;
      const list = document.getElementById('decisionTree');
      list.style.textAlign = "left";
      decisions.forEach((step, index) => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>Q:</strong> ${step.question}<br><strong>A:</strong> ${step.answer}` + (step.notes ? `<br><strong>Notes:</strong> ${step.notes}` : "");
        list.appendChild(li);
      });
    }

    function downloadSummary() {
      let content = 'Your Decision Tree:\n\n';
      decisions.forEach((step, index) => {
        content += `Q${index + 1}: ${step.question}\n`;
        content += `→ Answer: ${step.answer}\n`;
        if (step.notes) {
          content += `→ Notes: ${step.notes}\n`;
        }
        content += '\n';
      });
      const blob = new Blob([content], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'decision-tree-summary.txt';
      link.click();
    }

    document.getElementById('returnBtn').onclick = returnQuestion;
    document.getElementById('startOverBtn').onclick = startOver;

    renderQuestion();
  </script>
